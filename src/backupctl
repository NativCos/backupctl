#!/usr/bin/env bash
# Backup to a remote location using Borg.


if [ "$USER" != "root" ];
then
  echo "use sudo!" >&2
  exit 1
fi

# Configs
source /etc/backupctl/conf
export BORG_RSH="ssh -i ${SSH_PATH_TO_KEY}"
export BORG_REPO=${SSH_PATH_TO_REPO}
export BORG_PASSPHRASE=${PASSPHRASE}


case $1 in
  "init")
    borg init --encryption=repokey ::
  ;;
  "create")
    # Backup system
    BACKUP_NAME=$(hostname -s)-$(date +"%H:%M:%S-%d-%b-%Y")
    borg create -v --stats --progress ::${BACKUP_NAME} / --exclude-from /etc/backupctl/excludefile --compression lz4
    exit 0
  ;;
  "prune")
    # Prune extra backups Keep all backups in the last 7 days and 3 monthly
    borg prune -v --stats --list --keep-within=7d --keep-monthly=3 --prefix $(hostname -s)- ${@:2}
    exit 0
  ;;
  "list")
    borg list ::
    exit 0
  ;;
  "help")
    echo "backupctl [ init | create | prune [--keep-daily=3 --keep-weekly=1] | help ]"
    exit 0
  ;;
  *)
    echo "Unknown command..."
    exit 1
esac
