#!/usr/bin/env bash
# Backup to a remote location using Borg.
# To restore: borg extract username@offsite_server:/path/to/backup_repo::backup_name


# Configs
source /etc/backupctl/conf
export BORG_RSH="ssh -i ${SSH_PATH_TO_KEY}"
export BORG_REPO=${SSH_PATH_TO_REPO}
export BORG_PASSPHRASE=${PASSPHRASE}


case $1 in
  "init")
    borg init --encryption=repokey ::
  ;;
  "create")
    # Backup system
    BACKUP_NAME=$(hostname -s)-$(date +"%H:%M:%S-%d-%b-%Y")
    borg create -v --list --stats --progress ::${BACKUP_NAME} / --exclude-from /etc/backupctl/excludefile --compression lz4
    exit 0
  ;;
  "prune")
    # Prune extra backups
    borg prune --prefix $(hostname -s)- ${@:2}
    exit 0
  ;;
  "list")
    borg list ::
    exit 0
  ;;
  "extract")
    borg extract ::$2
  ;;
  "help")
    echo "backupctl [ init | create | prune [--keep-daily=3 --keep-weekly=1] | extract <<backup name>> | help ]"
    exit 0
  ;;
  *)
    echo "Unknown command..."
    exit 1
esac
